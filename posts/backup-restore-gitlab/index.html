<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Backup/Restore GitLab" /><meta property="og:locale" content="en" /><meta name="description" content="Do you have a small GitLab container running on an instance in AWS for yourself or a small team? Have you ever needed to back-up GitLab and move it to another machine wether that be on another instance or on-prem? The following are instructions on how to back-up GitLab in a container to an AWS S3 bucket, deploy a container of GitLab in another environment, pull down the backup, and finally restore the back-up on the new machine." /><meta property="og:description" content="Do you have a small GitLab container running on an instance in AWS for yourself or a small team? Have you ever needed to back-up GitLab and move it to another machine wether that be on another instance or on-prem? The following are instructions on how to back-up GitLab in a container to an AWS S3 bucket, deploy a container of GitLab in another environment, pull down the backup, and finally restore the back-up on the new machine." /><link rel="canonical" href="https://gore-ez-knee.github.io/posts/backup-restore-gitlab/" /><meta property="og:url" content="https://gore-ez-knee.github.io/posts/backup-restore-gitlab/" /><meta property="og:site_name" content="Gore-Ez-Knee" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-04T10:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Backup/Restore GitLab" /><meta name="twitter:site" content="@gore_ez_knee" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-05T09:06:56-05:00","datePublished":"2022-06-04T10:00:00-05:00","description":"Do you have a small GitLab container running on an instance in AWS for yourself or a small team? Have you ever needed to back-up GitLab and move it to another machine wether that be on another instance or on-prem? The following are instructions on how to back-up GitLab in a container to an AWS S3 bucket, deploy a container of GitLab in another environment, pull down the backup, and finally restore the back-up on the new machine.","headline":"Backup/Restore GitLab","mainEntityOfPage":{"@type":"WebPage","@id":"https://gore-ez-knee.github.io/posts/backup-restore-gitlab/"},"url":"https://gore-ez-knee.github.io/posts/backup-restore-gitlab/"}</script><title>Backup/Restore GitLab | Gore-Ez-Knee</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Gore-Ez-Knee"><meta name="application-name" content="Gore-Ez-Knee"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Gore-Ez-Knee</a></div><div class="site-subtitle font-italic">Nerd</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/gore-ez-knee" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/gore_ez_knee" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gore.ez.knee','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Backup/Restore GitLab</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1920 300'%3E%3C/svg%3E" data-src="/assets/img/post_images/gitlab_backup_restore/gitlab-banner.jpg" class="preview-img bg" alt="Preview Image" width="1920" height="300" data-proofer-ignore><h1 data-toc-skip>Backup/Restore GitLab</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/gore_ez_knee">Gore-Ez-Knee</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1654354800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-04 </em> </span> <span> Updated <em class="timeago" data-ts="1654438016" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-05 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="957 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p>Do you have a small GitLab container running on an instance in AWS for yourself or a small team? Have you ever needed to back-up GitLab and move it to another machine wether that be on another instance or on-prem? The following are instructions on how to back-up GitLab in a container to an AWS S3 bucket, deploy a container of GitLab in another environment, pull down the backup, and finally restore the back-up on the new machine.</p><p>The instructions should still work if you manually installed GitLab on a machine. I would recommend at least having it deployed with Docker Compose, because it’s way easier to update. My example Docker Compose file in Step 6 ensures GitLab always stays up-to-date without having to manually do it.</p><h2 id="step-1-create-s3-bucket"><span class="mr-2">Step 1. Create S3 Bucket</span><a href="#step-1-create-s3-bucket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create an S3 bucket. The <a href="https://docs.gitlab.com/ee/install/aws/manual_install_aws.html#architecture">architecture diagram</a> shows you can create multiple buckets for different GitLab objects. In this case, we’re just worried about setting up a backup bucket.</p><h2 id="step-2-create-an-iam-policy-for-the-instance-that-is-housing-gitlab"><span class="mr-2">Step 2. Create an IAM Policy for the Instance that is housing GitLab.</span><a href="#step-2-create-an-iam-policy-for-the-instance-that-is-housing-gitlab" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Using <a href="https://docs.gitlab.com/ee/install/aws/manual_install_aws.html#create-an-iam-policy">GitLab’s Documentation</a>, create an EC2 instance role for GitLab using the provided example policy. If all you are worried about is backups, just plug the backup bucket ARN into the resource. Example Policy:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>{   "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:PutObjectAcl"
            ],
            "Resource": "arn:aws:s3:::gl-backup-example-bucket/*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:AbortMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucketMultipartUploads"
            ],
            "Resource": "arn:aws:s3:::gl-backup-example-bucket"
        }
    ]
}
</pre></table></code></div></div><p>Once the policy has been created, attach the EC2 instance role to the instance.</p><h2 id="step-3-modify-gitlabrb-to-upload-backups-to-s3"><span class="mr-2">Step 3. Modify <code class="language-plaintext highlighter-rouge"><span class="mr-2">gitlab.rb</code> to upload backups to S3</span><a href="#step-3-modify-gitlabrb-to-upload-backups-to-s3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Drop into the the container (if you are using Docker): <code class="language-plaintext highlighter-rouge">sudo docker exec -it &lt;container-name/id&gt; /bin/bash</code><li>Modify the <code class="language-plaintext highlighter-rouge">gitlab.rb</code> file: <code class="language-plaintext highlighter-rouge">vi /etc/gitlab/gitlab.rb</code><li>Add the following to the <code class="language-plaintext highlighter-rouge">gitlab.rb</code> file:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  gitlab_rails['backup_upload_connection'] = {
  'provider' =&gt; 'AWS',
  'region' =&gt; 'us-gov-west-1',
  'use_iam_profile' =&gt; true
  }
  gitlab_rails['backup_upload_remote_directory'] = 'gl-backup-example-bucket'
</pre></table></code></div></div><li>Once added, reconfigure GitLab: <code class="language-plaintext highlighter-rouge">gitlab-ctl reconfigure</code><h2 id="step-4-create-a-backup"><span class="mr-2">Step 4. Create a Backup</span><a href="#step-4-create-a-backup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><li>Once the reconfigure has completed, you can create a backup from within the container:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  gitlab-backup create SKIP=registry
</pre></table></code></div></div><li>OR you can run the command from Docker:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  sudo docker exec -it gitlab gitlab-backup create SKIP=registry
</pre></table></code></div></div></ul><blockquote class="prompt-info"><div><p>Note: I skip the registry to avoid an error I received when trying to restore from backup. It got mad at me for not having a registry.gz file, or something like that. Since I wasn’t using GitLab’s registry, I just skipped it hence the <code class="language-plaintext highlighter-rouge">SKIP=registry</code></p></div></blockquote><ul><li>Once the command finishes, check the S3 bucket for a backup file. This command will also create a backup file in <code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups/</code><h2 id="step-5-manually-backup-the-gitlab-secretsjson-and-gitlabrb-files"><span class="mr-2">Step 5. Manually Backup the <code class="language-plaintext highlighter-rouge"><span class="mr-2">gitlab-secrets.json</code> and <code class="language-plaintext highlighter-rouge"><span class="mr-2">gitlab.rb</code> Files</span><a href="#step-5-manually-backup-the-gitlab-secretsjson-and-gitlabrb-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>When you create a backup, it does not backup the <code class="language-plaintext highlighter-rouge">gitlab-secrets.json</code> or <code class="language-plaintext highlighter-rouge">gitlab.rb</code> files. It even tells you you must back those two files up manually. I found that it was easier to push those files to the same bucket as the backups and pull them to the new instance. In our case, using Docker…</p><li>Copy the files from the mounted Docker volumes: <code class="language-plaintext highlighter-rouge">sudo cp /srv/gitlab/config/gitlab.rb /srv/gitlab/config/gitlab-secrets.json .</code><li>Move those files to your bucket:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  aws s3 cp gitlab.rb s3://gl-backup-example-bucket/
  aws s3 cp gitlab-secrets.json s3://gl-backup-example-bucket/
</pre></table></code></div></div><h2 id="step-6-restore-from-a-backup"><span class="mr-2">Step 6. Restore from a Backup</span><a href="#step-6-restore-from-a-backup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Whether you need to restore from a failure or move your GitLab to another instance, here is where you will restore the backup. ALSO the following commands assume you are running GitLab in a container. So on your new server: install docker, start docker, and install docker-compose. Next create a <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> file. Here is a sample one I use:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>version: '3.6'
services:
web:
  image: 'gitlab/gitlab-ee:latest'
  container_name: gitlab
  restart: always
  hostname: 'example.gitlab.com'
  ports:
    - '80:80'
    - '443:443'
    - '6222:22'
  volumes:
    - '/srv/gitlab/config:/etc/gitlab'
    - '/srv/gitlab/logs:/var/log/gitlab'
    - '/srv/gitlab/data:/var/opt/gitlab'
watchtower:
  image: containrrr/watchtower
  container_name: watchtower
  restart: always
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  command: --interval 300 --cleanup
</pre></table></code></div></div><p>Watchtower is here to check for new GitLab images every 5 minutes and deploys them with the same configs as well as clean up old images.</p><li>Spin up the containers: <code class="language-plaintext highlighter-rouge">sudo docker-compose up -d</code><li>Wait for the GitLab container to be healthy: <code class="language-plaintext highlighter-rouge">sudo watch docker ps</code><li>Once healthy, pull down the <code class="language-plaintext highlighter-rouge">gitlab.rb</code> file and place it into the container, chown it to root, and reconfigure:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  aws s3 cp s3://gl-backup-example-bucket/gitlab.rb .
  sudo docker cp gitlab.rb gitlab:/etc/gitlab/
  sudo docker exec -it gitlab chown root: /etc/gitlab/gitlab.rb
  sudo docker exec -it gitlab gitlab-ctl reconfigure
</pre></table></code></div></div><li>Once the reconfigure is finished, pull down the latest backup, place it into the container and chown it to git:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  aws s3 cp s3://gl-backup-example-bucket/11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar .
  sudo docker cp 11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar gitlab:/var/opt/gitlab/backups/11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar
  sudo docker exec -it gitlab chown git:git /var/opt/gitlab/backups/11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar
</pre></table></code></div></div><li>Stop the puma and sidekiq services and confirm the services are down:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  sudo docker exec -it gitlab gitlab-ctl stop puma
  sudo docker exec -it gitlab gitlab-ctl stop sidekiq
  sudo docker exec -it gitlab gitlab-ctl status
</pre></table></code></div></div><li>Restore the backup. Remember to ignore the <code class="language-plaintext highlighter-rouge">_gitlab_backup.tar</code>:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  sudo docker exec -it gitlab gitlab-backup restore BACKUP=11493107454_2018_04_25_10.6.4-ce
</pre></table></code></div></div><h2 id="step-7-load-the-gitlab-secretsjson-file-and-restart"><span class="mr-2">Step 7. Load the <code class="language-plaintext highlighter-rouge"><span class="mr-2">gitlab-secrets.json</code> file and Restart</span><a href="#step-7-load-the-gitlab-secretsjson-file-and-restart" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><li>Copy the file into the container, chown it root, and reconfigure:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  aws s3 cp s3://gl-backup-example-bucket/gitlab-secrets.json .
  sudo docker cp gitlab-secrets.json gitlab:/etc/gitlab/
  sudo docker exec -it gitlab chown root: /etc/gitlab/gitlab-secrets.json
  sudo docker exec -it gitlab gitlab-ctl reconfigure
</pre></table></code></div></div><li>Restart GitLab:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  sudo docker exec -it gitlab gitlab-ctl restart
</pre></table></code></div></div><li>And for safe measure, just restart the container:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  sudo docker restart gitlab
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">gitlab-ctl restart</code> might be irrelevant with restarting the container. I didn’t double-check to see if it was necessary.</p></ul><h2 id="step-8-profit"><span class="mr-2">Step 8. Profit</span><a href="#step-8-profit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/misc/'>Misc</a>, <a href='/categories/gitlab/'>GitLab</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/gitlab/" class="post-tag no-text-decoration" >gitlab</a> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/s3/" class="post-tag no-text-decoration" >s3</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/docker-compose/" class="post-tag no-text-decoration" >docker-compose</a> <a href="/tags/gitlab-ctl/" class="post-tag no-text-decoration" >gitlab-ctl</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Backup/Restore GitLab - Gore-Ez-Knee&amp;url=https://gore-ez-knee.github.io/posts/backup-restore-gitlab/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Backup/Restore GitLab - Gore-Ez-Knee&amp;u=https://gore-ez-knee.github.io/posts/backup-restore-gitlab/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://gore-ez-knee.github.io/posts/backup-restore-gitlab/&amp;text=Backup/Restore GitLab - Gore-Ez-Knee" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/kali-cloud-novnc/">Stream Kali Linux to your Browser from AWS</a><li><a href="/posts/backup-restore-gitlab/">Backup/Restore GitLab</a><li><a href="/posts/getting-started-cybersecurity/">Intro to Cybersecurity</a><li><a href="/posts/htb-ca-2022-writeup-table/">HTB Cyber Apocalypse CTF - Table of Write-ups</a><li><a href="/posts/elastic-install/">Quickstart Elastic Stack</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/gitlab/">gitlab</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/docker-compose/">docker-compose</a> <a class="post-tag" href="/tags/elastic/">elastic</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/evt/">evt</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ready/"><div class="card-body"> <em class="timeago small" data-ts="1645333200" > 2022-02-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ready</h3><div class="text-muted small"><p> Ready Enumeration $ sudo nmap -sC -sV -oA nmap/ready 10.10.10.220 Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-04 23:50 EDT Nmap scan report for 10.10.10.220 Host is up (0.066s latency). N...</p></div></div></a></div><div class="card"> <a href="/posts/kali-cloud-novnc/"><div class="card-body"> <em class="timeago small" data-ts="1664118000" > 2022-09-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Stream Kali Linux to your Browser from AWS</h3><div class="text-muted small"><p> Have you ever wanted to: Stand up an instance of a Kali desktop environment in the cloud to perform testing? Spin up a Linux desktop environment to bypass workspace restrictions? Browse webs...</p></div></div></a></div><div class="card"> <a href="/posts/ubuntu-server-setup/"><div class="card-body"> <em class="timeago small" data-ts="1648150200" > 2022-03-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ubuntu Server Setup</h3><div class="text-muted small"><p> Here is a guide I created to stand up an Ubuntu Server to test standing up an Elastic Stack. Downloaded the Ubuntu Server iso: https://ubuntu.com/download/server Using VMware Workstation...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/getting-started-cybersecurity/" class="btn btn-outline-primary" prompt="Older"><p>Intro to Cybersecurity</p></a> <a href="/posts/kali-cloud-novnc/" class="btn btn-outline-primary" prompt="Newer"><p>Stream Kali Linux to your Browser from AWS</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/gore_ez_knee">Gore-Ez-Knee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/gitlab/">gitlab</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/docker-compose/">docker-compose</a> <a class="post-tag" href="/tags/elastic/">elastic</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a> <a class="post-tag" href="/tags/evt/">evt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-BJ7S2G5H9F"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-BJ7S2G5H9F'); }); </script>
